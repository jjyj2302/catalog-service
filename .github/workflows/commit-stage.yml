name: Commit Stage
on: push

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3  # 현재 깃 저장소(catalog-service)를 체크아웃한다. 
      - name: Set up JDK 21
        uses: actions/setup-java@v3  # 자바 런타임을 설치하고 설정.
        with: # 사용할 버전, 배포, 캐시 유형을 정의.
          distribution: 'temurin'  # Temurin 배포판을 사용한다.
          java-version: '21'  # JDK 버전은 21로 설정한다.
          cache : gradle
      - name: Code Vulnerability scanning
        uses: anchore/scan-action@v3  # 그라이프를 사용해 취약성을 스캔.
        id: scan
        with:
          path: "${{ github.workspace }}"  # 스캔할 경로를 현재 작업 공간으로 지정.
          fail-build: false  # 보안 취약성 발견시 빌드 실패 여부
          severity-cutoff: high  # 심각도 컷오프를 높음으로 설정.
          acs-report-enable: true  # ACS 보고서 활성화.
      - name: Upload vulnerability report
        uses: github/codeql-action/upload-sarif@v2  # SARIF 형식의 취약성 보고서를 업로드.
        if: success() || failure() # 이전 단계가 실패하더라도 리포트 전송
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }} # 이전 단계 결과의 리포트를 가져온다.
      - name: Build, unit tests and integration tests
        run: |       
          chmod +x gradlew  
          ./gradlew build
          